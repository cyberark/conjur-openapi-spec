#!/bin/bash -e

cleanup() {
  echo "Cleaning up..."
  docker-compose rm --stop --force -v
}

if [ "$1" == "-d" ]; then
  DEBUG="true"
  shift
fi

bin/generate_client
bin/start_conjur

bin/get_conjur_admin_key

config/https/generate_csr

echo "Building and starting test env..."
docker-compose build test-python
docker-compose up -d test-python

rm -rf $CURRENT_DIR/out/*

if [[ "$DEBUG" == "true" ]]; then
  docker-compose exec test-python bash
  exit
fi

docker-compose run \
  --no-deps \
  test-python \
  nose2 --plugin nose2.plugins.junitxml --with-coverage --coverage-report xml -X -v -s test/python
