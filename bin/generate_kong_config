#!/usr/bin/env bash
set -e
. bin/util

announce "Bundling OpenAPI spec"
bin/bundle_spec

announce "Update spec: bump OAI version, include Docker host URL"
docker run --rm \
    -v "${PWD}:/opt/openapi" \
    python:latest /bin/bash -c "
        cd /opt/openapi && \\
        pip3 install pyyaml && \\
        python3 examples/kong/util.py bump_spec_version
        python3 examples/kong/util.py update_server_url
    "

announce "Generating Kong declarative configuration yaml"
docker run --rm \
    -v "${PWD}:/opt/openapi" \
    kong/inso:latest \
        --verbose \
        generate config /opt/openapi/tmp_spec.yml \
        --type declarative \
        --output /opt/openapi/out/kong/kong.yml
rm tmp_spec.yml

announce "Remove authentication plugins from API routes"
# these plugins consume authentication credentials instead of passing them to Conjur
docker run --rm \
    -v "${PWD}:/opt/openapi" \
    python:latest /bin/bash -c "
        cd /opt/openapi && \\
        pip3 install pyyaml && \\
        python3 examples/kong/util.py strip_plugins
    "

echo "Kong configuration written to out/kong/kong.yml"